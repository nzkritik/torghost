#!/usr/bin/env python3
"""
TorGhost - Clean and Working Version
"""

import os
import sys
import subprocess

# Check if running as sudo
if os.geteuid() != 0:
    print("This script requires sudo privileges.")
    os.execvp('sudo', ['sudo', sys.executable] + sys.argv)

# Venv and dependency management
venv_dir = os.path.join(os.path.expanduser('~'), '.venv')
if not os.path.exists(venv_dir):
    print(f"Creating virtual environment in {venv_dir}...")
    try:
        subprocess.run([sys.executable, '-m', 'venv', venv_dir], check=True)
    except subprocess.CalledProcessError:
        print("Failed to create virtual environment. Please ensure the 'venv' module is available.")
        sys.exit(1)

venv_python = os.path.join(venv_dir, 'bin', 'python')
if sys.executable != os.path.abspath(venv_python):
    print("Relaunching in virtual environment...")
    os.execv(venv_python, [venv_python] + sys.argv)

# The script now runs inside the venv. Deactivation is not needed;
# when the script exits, the process ends, and the parent shell is unaffected.

# Install/Upgrade dependencies
try:
    subprocess.run(
        [sys.executable, '-m', 'pip', 'install', '--upgrade', 'stem'], 
        check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
    )
except subprocess.CalledProcessError:
    print("Failed to install dependencies. Please check your internet connection and pip configuration.")
    sys.exit(1)

import time
import signal
import shutil
from stem import Signal
from stem.control import Controller


class bcolors:
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    RED = '\033[31m'
    YELLOW = '\033[93m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'


def t():
    return "[" + time.strftime('%H:%M:%S') + "]"


def sigint_handler(signum, frame):
    print('\nUser interrupt! Shutting down')
    shutdown()


def shutdown():
    print(f"\n{t()} Shutting down torghost")
    sys.exit()


def logo():
    os.system("clear")
    print(f"{bcolors.RED}{bcolors.BOLD}")
    print(r"""
      _____           ____ _               _
     |_   _|__  _ __ / ___| |__   ___  ___| |_
       | |/ _ \| '__| |  _| '_ \ / _ \/ __| __|
       | | (_) | |  | |_| | | | | (_) \__ \ |_
       |_|\___/|_|   \____|_| |_|\___/|___/\__|
    v2.0 - Koushik Pal
    """)
    print(f"{bcolors.ENDC}")


def usage():
    logo()
    print("""
    USAGE:
        sudo torghost start   (start torghost)
        sudo torghost stop    (stop torghost) 
        sudo torghost switch  (switch IP)
        torghost status       (show status)
    """)
    sys.exit()


def get_ip():
    try:
        result = subprocess.run(['curl', '-s', 'https://api.ipify.org'], 
                              capture_output=True, text=True)
        return result.stdout.strip()
    except:
        return "Unknown"


def start_torghost():
    # Configure torrc
    torrc_content = """
## TorGhost Configuration
VirtualAddrNetwork 10.0.0.0/10
AutomapHostsOnResolve 1
TransPort 9040
DNSPort 53
ControlPort 9051
"""
    
    with open('/etc/tor/torrc', 'r') as f:
        if '## TorGhost Configuration' not in f.read():
            with open('/etc/tor/torrc', 'a') as f_append:
                f_append.write(torrc_content)
    
    # Configure DNS
    if not os.path.exists('/etc/resolv.conf.bak-torghost'):
        shutil.copy('/etc/resolv.conf', '/etc/resolv.conf.bak-torghost')

    with open('/etc/resolv.conf', 'w') as f:
        f.write("nameserver 127.0.0.1\n")
    
    # Start services
    subprocess.run(['systemctl', 'start', 'tor'])
    
    # Setup iptables
    tor_uid = subprocess.run(['id', '-u', 'tor'], 
                           capture_output=True, text=True).stdout.strip()
    
    iptables_script = f"""
iptables -F
iptables -t nat -F
iptables -t nat -A OUTPUT -m owner --uid-owner {tor_uid} -j RETURN
iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports 53
iptables -t nat -A OUTPUT -p tcp --dport 53 -j REDIRECT --to-ports 53
iptables -t nat -A OUTPUT -d 192.168.1.0/24 -j RETURN
iptables -t nat -A OUTPUT -d 192.168.0.0/24 -j RETURN  
iptables -t nat -A OUTPUT -d 127.0.0.0/8 -j RETURN
iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports 9040
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -d 192.168.1.0/24 -j ACCEPT
iptables -A OUTPUT -d 192.168.0.0/24 -j ACCEPT
iptables -A OUTPUT -d 127.0.0.0/8 -j ACCEPT
iptables -A OUTPUT -m owner --uid-owner {tor_uid} -j ACCEPT
iptables -A OUTPUT -j REJECT
"""
    
    subprocess.run(['bash', '-c', iptables_script])
    print(f"{t()} CURRENT IP: {bcolors.GREEN}{get_ip()}{bcolors.ENDC}")
    print(f"{t()} {bcolors.GREEN}TorGhost started successfully.{bcolors.ENDC} Your traffic is being routed through Tor.")
    print(f"{t()} Run 'sudo torghost stop' to revert all changes.")


def stop_torghost():
    # Flush iptables
    subprocess.run(['bash', '-c', """
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -t nat -F
iptables -t mangle -F
iptables -F
iptables -X
"""])
    
    # Stop tor service
    subprocess.run(['systemctl', 'stop', 'tor'])

    # Clean up torrc
    torrc_content_to_remove = """
## TorGhost Configuration
VirtualAddrNetwork 10.0.0.0/10
AutomapHostsOnResolve 1
TransPort 9040
DNSPort 53
ControlPort 9051
"""
    with open('/etc/tor/torrc', 'r') as f:
        original_torrc = f.read()
    
    cleaned_torrc = original_torrc.replace(torrc_content_to_remove, "")
    
    with open('/etc/tor/torrc', 'w') as f:
        f.write(cleaned_torrc)
        
    # Restore network
    if os.path.exists('/etc/resolv.conf.bak-torghost'):
        shutil.move('/etc/resolv.conf.bak-torghost', '/etc/resolv.conf')
        
    print(f"{t()} CURRENT IP: {bcolors.GREEN}{get_ip()}{bcolors.ENDC}")
    print(f"{t()} {bcolors.YELLOW}TorGhost stopped.{bcolors.ENDC} Your traffic is no longer routed through Tor.")


def switch_tor():
    with Controller.from_port(port=9051) as controller:
        controller.authenticate()
        controller.signal(Signal.NEWNYM)
    time.sleep(5)
    print(f"{t()} CURRENT IP: {bcolors.GREEN}{get_ip()}{bcolors.ENDC}")


def show_status():
    ip = get_ip()
    tor_status = subprocess.run(['systemctl', 'is-active', 'tor'], 
                              capture_output=True, text=True).stdout.strip()
    print(f"Tor Status: {tor_status}")
    print(f"Current IP: {ip}")


# Main execution
signal.signal(signal.SIGINT, sigint_handler)

if len(sys.argv) < 2:
    usage()

command = sys.argv[1].lower()

if command in ['start', 'stop', 'switch']:
    if os.geteuid() != 0:
        print(f"{bcolors.RED}{bcolors.BOLD}You must be root to run this command.{bcolors.ENDC}")
        sys.exit(1)

if command == "start":
    logo()
    start_torghost()
elif command == "stop":
    logo()
    stop_torghost()
elif command == "switch":
    switch_tor()
elif command == "status":
    show_status()
else:
    usage()
